diff -uBp '-x*.o' router/rc.old/common_ex.c gateway/rc/common_ex.c
--- router/rc.old/common_ex.c	2009-09-24 21:36:12.000000000 +0400
+++ gateway/rc/common_ex.c	2009-10-18 16:52:43.000000000 +0400
@@ -26,6 +26,7 @@
 #include <errno.h>
 
 #include "rc.h"
+#include "mtd.h"
 
 #define XSTR(s) STR(s)
 #define STR(s) #s
@@ -88,7 +89,7 @@ void getsyspara(void)
 	strcpy(productid, "WLHDD");
 	strcpy(fwver, "0.1.0.1");
 
-	if ((fp = fopen("/dev/mtd/1", "rb"))!=NULL)
+	if ((fp = fopen(MTD_DEV(1), "rb"))!=NULL)
 	{
 		if (fseek(fp, 4, SEEK_SET)!=0) goto write_ver;
 		fread(dataPtr, 1, 4, fp);
diff -uBp '-x*.o' router/rc.old/Makefile gateway/rc/Makefile
--- router/rc.old/Makefile	2009-10-18 19:23:51.000000000 +0400
+++ gateway/rc/Makefile	2009-10-18 19:48:46.000000000 +0400
@@ -16,7 +16,7 @@ ifneq ($(MAKECMDGOALS),clean)
 include $(TOP)/.config
 endif
 
-CFLAGS	+= -I. -I$(TOP)/shared -I$(SRCBASE)/include -Wall -DASUS_EXT $(GLOBAL_OPTIONS)
+CFLAGS	+= -I. -I$(TOP)/shared -I$(SRCBASE)/include -idirafter$(LINUXDIR)/include -Wall -DASUS_EXT $(GLOBAL_OPTIONS)
 #CFLAGS	+= -g -DDEBUG
 CFLAGS	+= -s -O2 $(EXTRACFLAGS)
 LDFLAGS	+= -L$(TOP)/nvram -L$(INSTALLDIR)/nvram/usr/lib -lnvram -L$(TOP)/shared -L$(INSTALLDIR)/shared/usr/lib -lshared -lcrypt
@@ -49,6 +49,7 @@ install: all
 	install rc $(INSTALLDIR)/sbin
 	$(STRIP) $(INSTALLDIR)/sbin/rc
 	cd $(INSTALLDIR)/sbin && ln -sf rc init
+	ln -sf rc $(INSTALLDIR)/sbin/preinit
 	cd $(INSTALLDIR)/sbin && ln -sf rc erase
 	cd $(INSTALLDIR)/sbin && ln -sf rc write
 	cd $(INSTALLDIR)/sbin && ln -sf rc flash
diff -uBp '-x*.o' router/rc.old/mtd.c gateway/rc/mtd.c
--- router/rc.old/mtd.c	2008-03-19 20:07:24.000000000 +0300
+++ gateway/rc/mtd.c	2009-10-18 19:38:00.000000000 +0400
@@ -26,13 +26,20 @@
 #include <sys/ioctl.h>
 #include <sys/sysinfo.h>
 
+#ifdef LINUX26
+#include <linux/compiler.h>
+#include <mtd/mtd-user.h>
+#else
 #include <linux/mtd/mtd.h>
+#endif
 
 #include <trxhdr.h>
 #include <rts/crc.h>
 #include <bcmutils.h>
 #include <shutils.h>
 
+#include "mtd.h"
+
 /*
  * Open an MTD device
  * @param	mtd	path to or partition name of MTD device
@@ -49,7 +56,7 @@ mtd_open(const char *mtd, int flags)
 	if ((fp = fopen("/proc/mtd", "r"))) {
 		while (fgets(dev, sizeof(dev), fp)) {
 			if (sscanf(dev, "mtd%d:", &i) && strstr(dev, mtd)) {
-				snprintf(dev, sizeof(dev), "/dev/mtd/%d", i);
+				snprintf(dev, sizeof(dev), MTD_DEV(%d), i);
 				fclose(fp);
 				return open(dev, flags);
 			}
diff -uBp '-x*.o' router/rc.old/mtd.h gateway/rc/mtd.h
--- router/rc.old/mtd.h	2008-03-19 20:07:24.000000000 +0300
+++ gateway/rc/mtd.h	2009-10-18 17:01:22.000000000 +0400
@@ -1,7 +1,7 @@
 /*
  * MTD utility functions
  *
- * Copyright 2004, Broadcom Corporation
+ * Copyright 2006, Broadcom Corporation
  * All Rights Reserved.
  * 
  * THIS SOFTWARE IS OFFERED "AS IS", AND BROADCOM GRANTS NO WARRANTIES OF ANY
@@ -9,12 +9,20 @@
  * SPECIFICALLY DISCLAIMS ANY IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS
  * FOR A SPECIFIC PURPOSE OR NONINFRINGEMENT CONCERNING THIS SOFTWARE.
  *
- * $Id$
+ * $Id: mtd.h,v 1.1.1.1 2008/07/21 09:17:42 james26_jang Exp $
  */
 
 #ifndef _mtd_h_
 #define _mtd_h_
 
+#ifdef LINUX26
+ #define	MTD_DEV(arg)		"/dev/mtd"#arg
+ #define	MTD_BLKDEV(arg)		"/dev/mtdblock"#arg
+#else
+ #define	MTD_DEV(arg)		"/dev/mtd/"#arg
+ #define	MTD_BLKDEV(arg)		"/dev/mtdblock/"#arg
+#endif
+
 /*
  * Open an MTD device
  * @param	mtd	path to or partition name of MTD device
@@ -35,14 +43,6 @@ extern int mtd_erase(const char *mtd);
  * @param	path	file to write or a URL
  * @param	mtd	path to or partition name of MTD device 
  * @return	0 on success and errno on failure
- */
-extern int mtd_write(const char *path, const char *mtd);
-
-/*
- * Flash a file to an MTD device
- * @param	path	file to write or a URL
- * @param	mtd	path to or partition name of MTD device 
- * @return	0 on success and errno on failure
  */
 extern int mtd_write(const char *path, const char *mtd);
 
diff -uBp '-x*.o' router/rc.old/network.c gateway/rc/network.c
--- router/rc.old/network.c	2009-09-18 02:12:58.000000000 +0400
+++ gateway/rc/network.c	2009-10-18 17:10:07.000000000 +0400
@@ -1446,7 +1446,11 @@ hotplug_net(void)
 	if (strncmp(interface, "wds", 3))
 		return 0;
 
+#ifdef LINUX26
+	if (!strcmp(action, "add")) {
+#else
 	if (!strcmp(action, "register")) {
+#endif
 		/* Bring up the interface and add to the bridge */
 		ifconfig(interface, IFUP, NULL, NULL);
 		
diff -uBp '-x*.o' router/rc.old/rc.c gateway/rc/rc.c
--- router/rc.old/rc.c	2009-04-26 17:54:12.000000000 +0400
+++ gateway/rc/rc.c	2009-10-18 20:47:58.000000000 +0400
@@ -479,7 +479,7 @@ canned_config:
 
 	/* Always set OS defaults */
 	nvram_set("os_name", "linux");
-	nvram_set("os_version", EPI_ROUTER_VERSION_STR);
+	nvram_set("os_version", EPI_VERSION_STR);
 	nvram_set("os_date", __DATE__);
 
 	nvram_set("is_modified", "0");
@@ -599,6 +599,12 @@ sysinit(void)
 	/* /proc */
 	mount("proc", "/proc", "proc", MS_MGC_VAL, NULL);
 
+#ifdef LINUX26
+	mount("sysfs", "/sys", "sysfs", MS_MGC_VAL, NULL);
+	mkdir("/dev/pts", 0777);
+	mount("devpts", "/dev/pts", "devpts", MS_MGC_VAL, NULL);
+#endif
+
 	/* /tmp */
 	mount("tmpfs", "/tmp", "tmpfs", MS_MGC_VAL | MS_NOATIME, NULL);
 
@@ -629,6 +629,11 @@ sysinit(void)
 	if (console_init())
 		noconsole = 1;
 
+#ifdef LINUX26
+	mkdir("/dev/shm", 0777);
+	eval("/sbin/hotplug2", "--coldplug");
+#endif
+
 	/* load flashfs */
 	if (!eval("flashfs", "start"))
 		eval("/usr/local/sbin/pre-boot");
@@ -638,7 +647,7 @@ sysinit(void)
 #if defined(CONFIG_WLHDD) || defined(CONFIG_WL700G)
 		modules = nvram_get("kernel_mods") ? : "ide-mod ide-probe-mod ide-disk et wl";
 #else
-		modules = nvram_get("kernel_mods") ? : "et wl";
+		modules = nvram_get("kernel_mods") ? : "et emf igs wl";
 #endif
 		foreach(module, modules, next)
 			eval("insmod", module);
@@ -889,7 +898,13 @@ main(int argc, char **argv)
 	base = base ? base + 1 : argv[0];
 
 	/* init */
+#ifdef LINUX26
+        if (strstr(base, "preinit")) {
+                mount("devfs", "/dev", "tmpfs", MS_MGC_VAL | MS_NOATIME, NULL);
+                mknod("/dev/console", S_IRWXU|S_IFCHR, makedev(5, 1));
+#else /* LINUX26 */
 	if (strstr(base, "init")) {
+#endif /* LINUX26 */
 		main_loop();
 		return 0;
 	}
diff -uBp '-x*.o' router/rc.old/watchdog.c gateway/rc/watchdog.c
--- router/rc.old/watchdog.c	2009-03-02 21:49:13.000000000 +0300
+++ gateway/rc/watchdog.c	2009-10-18 16:52:26.000000000 +0400
@@ -27,6 +27,8 @@
 #include <stdarg.h>
 #include <wlioctl.h>
 
+#include "mtd.h"
+
 #define BCM47XX_SOFTWARE_RESET  0x40		/* GPIO 6 */
 #define RESET_WAIT		3		/* seconds */
 #define RESET_STATE		5		/* seconds */
@@ -292,7 +294,7 @@ void btn_check(void)
 #endif
 			case 1:	/* restore to defaults */
 				alarmtimer(0, 0);
-				eval("erase", "/dev/mtd/3");
+				eval("erase", MTD_DEV(3));
 				kill(1, SIGTERM);
 				break;
 			}
